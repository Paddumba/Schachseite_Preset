<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Schach WebApp</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
        <script src="static/js/chessboard-1.0.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    </head>
<body>
    <h1>Tagespuzzle von Lichess</h1>
    <button onclick="loadPuzzle()">Puzzle laden</button>
    
    <div id="board" style="width: 400px;"></div>
    <p id="message"></p>

    <script>
        let board = Chessboard('board', {
             draggable: true,
             position: 'start', onDrop: handleMove });
        let game = new Chess();
        let solution = [];
        let currentMoveIndex = 0;

        async function loadPuzzle() {
            document.getElementById("message").innerText = "Lade Puzzle...";
            
            let response = await fetch("/get_puzzle");
            let data = await response.json();

            if (data.error) {
                document.getElementById("message").innerText = data.error;
                return;
            }

            game = new Chess(data.fen);
            board.position(data.fen);
            solution = data.solution;
            currentMoveIndex = 0;

            document.getElementById("message").innerText = "Puzzle geladen! Dein Zug.";
        }
        
        //Oben ist die Brett so definiert, dass bei onDrop handlemove ausgef√ºhrt wird
        async function handleMove(source, target) {
            let move = source + target;
            let oldFen = board.fen();

            try {
                // 1Ô∏è‚É£ Spielerzug ans Backend senden
                let response = await fetch("/puzzlemove", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ "move": move })  // UCI-Zug an Backend senden
                });

                let data = await response.json();

                if (data.error) {
                    alert(data.error);
                    board.position(oldFen)
                
                }

                // 2Ô∏è‚É£ Spielerzug auf dem Brett ausf√ºhren
                game.move({ from: source, to: target });
                board.position(data.fen);

                if (data.message === "Gl√ºckwunsch! Puzzle gel√∂st!") {
                    document.getElementById("message").innerText = data.message;
                    return;  // üéØ Sofort beenden, kein Gegnerzug mehr n√∂tig
        }

        
        
                //document.getElementById("message").innerText = "Richtiger Zug! Warte auf Gegner...";

                // 3Ô∏è‚É£ Falls Gegnerzug folgt, warte darauf und f√ºhre ihn automatisch aus
                if (data.waiting_for_opponent) {
                    setTimeout(fetchOpponentMove, 1000);  // 1 Sekunde warten, dann Gegnerzug abrufen
                }

            } catch (error) {
                console.error("Fehler bei der Anfrage:", error);
                alert("Fehler bei der Kommunikation mit dem Server.");
            }
        }

        // Funktion, um den Gegnerzug abzurufen und auszuf√ºhren
        async function fetchOpponentMove() {
            try {
                let response = await fetch("/get_opponent_move", { method: "GET" });
                let data = await response.json();

                if (data.opponent_move) {
                    let opponentMove = data.opponent_move;
                    let source_opponent = opponentMove.substring(0, 2);
                    let target_opponent = opponentMove.substring(2, 4);

                    game.move({ from: source_opponent, to: target_opponent });
                    board.position(data.fen);
                    document.getElementById("message").innerText = "Gegner hat gezogen! Dein Zug.";
                }
            } catch (error) {
                console.error("Fehler beim Abrufen des Gegnerzugs:", error);
            }
        }
    </script>
</body>
</html>