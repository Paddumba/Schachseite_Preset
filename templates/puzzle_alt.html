<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Schach WebApp</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
        <script src="static/js/chessboard-1.0.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    </head>
<body>
    <h1>Tagespuzzle von Lichess</h1>
    <button onclick="loadPuzzle()">Puzzle laden</button>
    
    <div id="board" style="width: 400px;"></div>
    <p id="message"></p>

    <script>
        let board = Chessboard('board', {
             draggable: true,
             position: 'start', onDrop: handleMove });
        let game = new Chess();
        let solution = [];
        let currentMoveIndex = 0;

        async function loadPuzzle() {
            document.getElementById("message").innerText = "Lade Puzzle...";
            
            let response = await fetch("/get_puzzle");
            let data = await response.json();

            if (data.error) {
                document.getElementById("message").innerText = data.error;
                return;
            }

            game = new Chess(data.fen);
            board.position(data.fen);
            solution = data.solution;
            currentMoveIndex = 0;

            document.getElementById("message").innerText = "Puzzle geladen! Dein Zug.";
        }
        
        //Oben ist die Brett so definiert, dass bei onDrop handlemove ausgeführt wird
        async function handleMove(source, target) {
            let move = source + target;

            // Prüfen, ob der Zug des Spielers korrekt ist
            if (move === solution[currentMoveIndex]) {
            // Den Spielerzug über das Backend verarbeiten
            let response = await fetch("/puzzlemove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "move": move })
            });

            let data = await response.json();

            if (data.error) {
                alert(data.error);  // Falls Fehler auftreten
            } else {
                // Das Schachbrett aktualisieren und den Status ausgeben
                board.position(data.fen);
             document.getElementById("message").innerText = data.status;

                currentMoveIndex++;

            if (currentMoveIndex < solution.length) {
                // Gegnerzug durchführen, wenn er existiert
                if (currentMoveIndex % 2 !== 0) {  // Ungerade Indizes: Gegnerzug
                    let opponentMove = solution[currentMoveIndex];
                    let source_opponent = opponentMove.substring(0, 2);
                    let target_opponent = opponentMove.substring(2, 4);

                    // Gegnerzug direkt auf dem Schachbrett ausführen
                    game.move({ from: source_opponent, to: target_opponent });
                    board.position(game.fen());
                    currentMoveIndex++;
                }
            }
        }
    }       else {
            alert("Falscher Zug! Versuche es erneut.");
    }
}
    </script>
</body>
</html>